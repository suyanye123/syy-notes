<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nextcloud性能优化 | 前端小札</title>
    <meta name="description" content="">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?8092fab2f2adfc7938ba5b8885aef5b4";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <link rel="icon" href="/syy-notes/favicon.ico">
    <link rel="manifest" href="/syy-notes/manifest.json">
    <link rel="apple-touch-icon" href="/syy-notes/favicon.ico">
    <link rel="mask-icon" href="/syy-notes/favicon.ico" color="#3eaf7c">
    <meta name="description" content="前端常用知识、踩坑记录等">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/favicon.ico">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/syy-notes/assets/css/0.styles.fa044e56.css" as="style"><link rel="preload" href="/syy-notes/assets/js/app.094dc226.js" as="script"><link rel="preload" href="/syy-notes/assets/js/2.c240e540.js" as="script"><link rel="preload" href="/syy-notes/assets/js/5.d4bdd74c.js" as="script"><link rel="preload" href="/syy-notes/assets/js/21.29e7cf26.js" as="script"><link rel="preload" href="/syy-notes/assets/js/6.0490b026.js" as="script"><link rel="prefetch" href="/syy-notes/assets/js/10.bfc8ad50.js"><link rel="prefetch" href="/syy-notes/assets/js/11.23bb1da2.js"><link rel="prefetch" href="/syy-notes/assets/js/12.c7feea3b.js"><link rel="prefetch" href="/syy-notes/assets/js/13.9655fd52.js"><link rel="prefetch" href="/syy-notes/assets/js/14.185ee0c3.js"><link rel="prefetch" href="/syy-notes/assets/js/15.8d781460.js"><link rel="prefetch" href="/syy-notes/assets/js/16.7097cabe.js"><link rel="prefetch" href="/syy-notes/assets/js/17.b94ddbb7.js"><link rel="prefetch" href="/syy-notes/assets/js/18.aea2e585.js"><link rel="prefetch" href="/syy-notes/assets/js/19.8136eaee.js"><link rel="prefetch" href="/syy-notes/assets/js/20.eddffe12.js"><link rel="prefetch" href="/syy-notes/assets/js/22.a000116e.js"><link rel="prefetch" href="/syy-notes/assets/js/23.85568f11.js"><link rel="prefetch" href="/syy-notes/assets/js/24.f27c081f.js"><link rel="prefetch" href="/syy-notes/assets/js/25.0928357c.js"><link rel="prefetch" href="/syy-notes/assets/js/26.76bfdd05.js"><link rel="prefetch" href="/syy-notes/assets/js/27.e06db3ee.js"><link rel="prefetch" href="/syy-notes/assets/js/28.c2979f61.js"><link rel="prefetch" href="/syy-notes/assets/js/29.37997cf3.js"><link rel="prefetch" href="/syy-notes/assets/js/3.18859c8d.js"><link rel="prefetch" href="/syy-notes/assets/js/30.805d8aa8.js"><link rel="prefetch" href="/syy-notes/assets/js/31.e5f2e42d.js"><link rel="prefetch" href="/syy-notes/assets/js/32.f49f294d.js"><link rel="prefetch" href="/syy-notes/assets/js/33.5d7edeeb.js"><link rel="prefetch" href="/syy-notes/assets/js/34.e2db2183.js"><link rel="prefetch" href="/syy-notes/assets/js/35.eb7c48e3.js"><link rel="prefetch" href="/syy-notes/assets/js/36.0242f987.js"><link rel="prefetch" href="/syy-notes/assets/js/37.6265e88a.js"><link rel="prefetch" href="/syy-notes/assets/js/38.cf5cee9d.js"><link rel="prefetch" href="/syy-notes/assets/js/39.bf5a8d88.js"><link rel="prefetch" href="/syy-notes/assets/js/4.5d6618c5.js"><link rel="prefetch" href="/syy-notes/assets/js/40.d6ba4764.js"><link rel="prefetch" href="/syy-notes/assets/js/41.7ae25acf.js"><link rel="prefetch" href="/syy-notes/assets/js/42.175b2cc3.js"><link rel="prefetch" href="/syy-notes/assets/js/43.33201b33.js"><link rel="prefetch" href="/syy-notes/assets/js/44.c111c48b.js"><link rel="prefetch" href="/syy-notes/assets/js/45.b6fff7a8.js"><link rel="prefetch" href="/syy-notes/assets/js/46.06f058a8.js"><link rel="prefetch" href="/syy-notes/assets/js/47.c98df0b8.js"><link rel="prefetch" href="/syy-notes/assets/js/48.0732eee4.js"><link rel="prefetch" href="/syy-notes/assets/js/49.139045f9.js"><link rel="prefetch" href="/syy-notes/assets/js/50.ccabdd46.js"><link rel="prefetch" href="/syy-notes/assets/js/51.5dc5b3aa.js"><link rel="prefetch" href="/syy-notes/assets/js/52.a7db484f.js"><link rel="prefetch" href="/syy-notes/assets/js/7.e308006f.js"><link rel="prefetch" href="/syy-notes/assets/js/8.c69040e4.js"><link rel="prefetch" href="/syy-notes/assets/js/9.e8b1b3c4.js">
    <link rel="stylesheet" href="/syy-notes/assets/css/0.styles.fa044e56.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/syy-notes/" class="home-link router-link-active"><!----> <span class="site-name">前端小札</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作项目" class="dropdown-title"><span class="title">工作项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="工作项目" class="mobile-dropdown-title"><span class="title">工作项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://admin.yuke520.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后台管理系统
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/syy-notes/uniapp/yukexcx.html" class="nav-link">
  裕客商城小程序
</a></li></ul></div></div><div class="nav-item"><a href="https://yu-nan.gitee.io/suui" target="_blank" rel="noopener noreferrer" class="nav-link external">
   suUI 
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.syy123.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  言叶之庭
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/suyanye123/syy-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/syy-notes/introduce/" class="nav-link">
  关于我
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作项目" class="dropdown-title"><span class="title">工作项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="工作项目" class="mobile-dropdown-title"><span class="title">工作项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://admin.yuke520.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后台管理系统
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/syy-notes/uniapp/yukexcx.html" class="nav-link">
  裕客商城小程序
</a></li></ul></div></div><div class="nav-item"><a href="https://yu-nan.gitee.io/suui" target="_blank" rel="noopener noreferrer" class="nav-link external">
   suUI 
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.syy123.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  言叶之庭
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/suyanye123/syy-notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/syy-notes/introduce/" class="nav-link">
  关于我
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/syy-notes/mytools/" class="sidebar-link">网页工具</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/syy-notes/demo/" class="sidebar-heading clickable router-link-active"><span>我的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/syy-notes/mix/" class="sidebar-heading clickable"><span>混合开发</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/syy-notes/git/" class="sidebar-link">Git</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/syy-notes/webGL/" class="sidebar-heading clickable"><span>WebGL</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/syy-notes/utils/" class="sidebar-heading clickable"><span>utils</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/syy-notes/freeTalk/" class="sidebar-heading clickable"><span>写点东西</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nextcloud性能优化"><a href="#nextcloud性能优化" class="header-anchor">#</a> nextcloud性能优化</h1> <h3 id="_1-更改后台执行方式"><a href="#_1-更改后台执行方式" class="header-anchor">#</a> 1.更改后台执行方式</h3> <p>NC的后台任务执行方式分为3中，<code>AJAX</code>、<code>Webcron</code>、<code>Cron</code></p> <p>默认是AJAX即在每次访问Nextcloud任意页面都会通过AJAX的方式发起定时任务的执行请求，这种方式如果没有自己的独立服务器或者VPS的话还是比较方便省心的</p> <p>但官方推荐使用<code>Cron</code>，和Nginx或Apache等WEB服务独立开来，互不影响</p> <p>在Nextcloud设置 — 基本设置里，选择为 <code>Cron</code></p> <p>进入容器修改</p> <div class="language-bash extra-class"><pre class="language-bash"><code> docker <span class="token builtin class-name">exec</span> --user www-data nextcloud php cron.php
</code></pre></div><h3 id="_2-内存缓存"><a href="#_2-内存缓存" class="header-anchor">#</a> 2.内存缓存</h3> <p><strong>给nextcloud配置redis锁（网上有很多nc性能优化都提到了这个）</strong></p> <p>通过使用内存作为数据缓存的话，可以提高NC的性能，以加快WEB端的访问速度，并且Nextcloud支持多个内存缓存后端，如<code>APCu</code>、<code>Redis</code>、<code>Memcached</code> 来缓存资源文件或者采用CDN加速等等手段</p> <p>Nextcloud支持多个不同类型的缓存后端，所以可以同时启用本地缓存（APCu）和分布式缓存（Memcached、Redis）</p> <p>官方推荐的组合是APCu+Redis其他的缓存后端配置请参阅：<a href="https://docs.nextcloud.com/server/18/admin_manual/configuration_server/caching_configuration.html" target="_blank" rel="noopener noreferrer">Nextcloud内存缓存优化的官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>docker装redis，修改config.php，增加锁的引用。</p> <p>效果非常明显，sql语句只有insert 语句了，这个是正常的。IO也没之前高了。</p> <h3 id="_3-启用http2-提高加载速度"><a href="#_3-启用http2-提高加载速度" class="header-anchor">#</a> 3.启用http2，提高加载速度</h3> <p>nginx.conf 如下</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span>
<span class="token punctuation">{</span>
    <span class="token comment">#基础配置，这些可以照搬宝塔的配置</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> file<span class="token punctuation">.</span>bugxia<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm default<span class="token punctuation">.</span>php default<span class="token punctuation">.</span>htm default<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>www<span class="token operator">/</span>wwwroot<span class="token operator">/</span>file<span class="token punctuation">.</span>bugxia<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">client_max_body_size</span> <span class="token number">10</span>G<span class="token punctuation">;</span> 
    <span class="token keyword">fastcgi_buffers</span> <span class="token number">64</span> <span class="token number">4</span>K<span class="token punctuation">;</span>
    <span class="token keyword">gzip</span> on<span class="token punctuation">;</span>
    <span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span>
    <span class="token keyword">gzip_comp_level</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">gzip_min_length</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token keyword">gzip_proxied</span> expired no<span class="token operator">-</span>cache no<span class="token operator">-</span>store private no_last_modified no_etag <span class="token keyword">auth</span><span class="token punctuation">;</span>
    <span class="token keyword">gzip_types</span> application<span class="token operator">/</span>atom<span class="token operator">+</span>xml application<span class="token operator">/</span>javascript application<span class="token operator">/</span>json application<span class="token operator">/</span>ld<span class="token operator">+</span>json application<span class="token operator">/</span>manifest<span class="token operator">+</span>json application<span class="token operator">/</span>rss<span class="token operator">+</span>xml application<span class="token operator">/</span>vnd<span class="token punctuation">.</span><span class="token keyword">geo</span><span class="token operator">+</span>json application<span class="token operator">/</span>vnd<span class="token punctuation">.</span>ms<span class="token operator">-</span>fontobject application<span class="token operator">/</span>x<span class="token operator">-</span>font<span class="token operator">-</span>ttf application<span class="token operator">/</span>x<span class="token operator">-</span>web<span class="token operator">-</span>app<span class="token operator">-</span>manifest<span class="token operator">+</span>json application<span class="token operator">/</span>xhtml<span class="token operator">+</span>xml application<span class="token operator">/</span>xml font<span class="token operator">/</span>opentype image<span class="token operator">/</span>bmp image<span class="token operator">/</span>svg<span class="token operator">+</span>xml image<span class="token operator">/</span>x<span class="token operator">-</span>icon text<span class="token operator">/</span>cache<span class="token operator">-</span>manifest text<span class="token operator">/</span>css text<span class="token operator">/</span>plain text<span class="token operator">/</span>vcard text<span class="token operator">/</span>vnd<span class="token punctuation">.</span>rim<span class="token punctuation">.</span><span class="token keyword">location</span><span class="token punctuation">.</span>xloc text<span class="token operator">/</span>vtt text<span class="token operator">/</span>x<span class="token operator">-</span>component text<span class="token operator">/</span>x<span class="token operator">-</span>cross<span class="token operator">-</span>domain<span class="token operator">-</span>policy<span class="token punctuation">;</span>
    
    <span class="token comment">#nextcloud包含了403和404的错误页面</span>
    <span class="token keyword">error_page</span> <span class="token number">403</span> <span class="token operator">/</span>core<span class="token operator">/</span>templates<span class="token operator">/</span><span class="token number">403.</span>php<span class="token punctuation">;</span>
    <span class="token keyword">error_page</span> <span class="token number">404</span> <span class="token operator">/</span>core<span class="token operator">/</span>templates<span class="token operator">/</span><span class="token number">404.</span>php<span class="token punctuation">;</span>
    
    <span class="token comment">#防止一些HTTP响应头引起的安全隐患</span>
    <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">'max-age=15552000'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options <span class="token string">'nosniff'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Robots<span class="token operator">-</span>Tag <span class="token string">'none'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Frame<span class="token operator">-</span>Options <span class="token string">'SAMEORIGIN'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Download<span class="token operator">-</span>Options <span class="token string">'noopen'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Permitted<span class="token operator">-</span>Cross<span class="token operator">-</span>Domain<span class="token operator">-</span>Policies <span class="token string">'none'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> X<span class="token operator">-</span>XSS<span class="token operator">-</span>Protection <span class="token string">'1;mode=block'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Referrer<span class="token operator">-</span>Policy <span class="token string">&quot;no-referrer&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">#SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则</span>
    <span class="token comment">#error_page 404/404.html;</span>
    <span class="token keyword">ssl_certificate</span>    <span class="token operator">/</span>www<span class="token operator">/</span><span class="token keyword">server</span><span class="token operator">/</span>panel<span class="token operator">/</span>vhost<span class="token operator">/</span>cert<span class="token operator">/</span>file<span class="token punctuation">.</span>bugxia<span class="token punctuation">.</span>com<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate_key</span>    <span class="token operator">/</span>www<span class="token operator">/</span><span class="token keyword">server</span><span class="token operator">/</span>panel<span class="token operator">/</span>vhost<span class="token operator">/</span>cert<span class="token operator">/</span>file<span class="token punctuation">.</span>bugxia<span class="token punctuation">.</span>com<span class="token operator">/</span>privkey<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>
    <span class="token keyword">ssl_protocols</span> TLSv1 TLSv1<span class="token punctuation">.</span><span class="token number">1</span> TLSv1<span class="token punctuation">.</span><span class="token number">2</span> TLSv1<span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">ssl_ciphers</span> ECDHE<span class="token operator">-</span>RSA<span class="token operator">-</span>AES128<span class="token operator">-</span>GCM<span class="token operator">-</span>SHA256<span class="token punctuation">:</span>HIGH<span class="token punctuation">:</span><span class="token operator">!</span>aNULL<span class="token punctuation">:</span><span class="token operator">!</span>MD5<span class="token punctuation">:</span><span class="token operator">!</span>RC4<span class="token punctuation">:</span><span class="token operator">!</span>DHE<span class="token punctuation">;</span>
    <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>
    <span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span><span class="token number">10</span>m<span class="token punctuation">;</span>
    <span class="token keyword">ssl_session_timeout</span> <span class="token number">10</span>m<span class="token punctuation">;</span>
    <span class="token keyword">error_page</span> <span class="token number">497</span>  <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token comment">#SSL-END</span>

    <span class="token comment">#PHP-INFO-START  PHP引用配置，可以注释或修改</span>
    <span class="token comment">#include enable-php-74.conf;</span>
    <span class="token comment">#PHP-INFO-END</span>
    
    <span class="token comment">#REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效</span>
    <span class="token keyword">include</span> <span class="token operator">/</span>www<span class="token operator">/</span><span class="token keyword">server</span><span class="token operator">/</span>panel<span class="token operator">/</span>vhost<span class="token operator">/</span><span class="token keyword">rewrite</span><span class="token operator">/</span>file<span class="token punctuation">.</span>bugxia<span class="token punctuation">.</span>com<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
    <span class="token comment">#REWRITE-END</span>
    
    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token punctuation">.</span>well<span class="token operator">-</span>known<span class="token operator">/</span>carddav <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">301</span> <span class="token variable">$scheme</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token punctuation">:</span><span class="token variable">$server_port</span><span class="token operator">/</span>remote<span class="token punctuation">.</span>php<span class="token operator">/</span>dav<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token punctuation">.</span>well<span class="token operator">-</span>known<span class="token operator">/</span>caldav <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">301</span> <span class="token variable">$scheme</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token punctuation">:</span><span class="token variable">$server_port</span><span class="token operator">/</span>remote<span class="token punctuation">.</span>php<span class="token operator">/</span>dav<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">#Let's Encrypt 证书续期验证目录</span>
    <span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span>well<span class="token operator">-</span>known<span class="token punctuation">{</span>
        <span class="token keyword">allow</span> all<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">#nextcloud一些关键目录的权限设置</span>
    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span>\<span class="token operator">/</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>build<span class="token operator">|</span>tests<span class="token operator">|</span>config<span class="token operator">|</span>lib<span class="token operator">|</span><span class="token number">3</span>rdparty<span class="token operator">|</span>templates<span class="token operator">|</span>data<span class="token punctuation">)</span>\<span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">deny</span> all<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span>\<span class="token operator">/</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>\<span class="token punctuation">.</span><span class="token operator">|</span>autotest<span class="token operator">|</span>occ<span class="token operator">|</span>issue<span class="token operator">|</span>indie<span class="token operator">|</span>db_<span class="token operator">|</span>console<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">deny</span> all<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">[</span><span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">]</span>\<span class="token punctuation">.</span><span class="token function">php</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">|</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">fastcgi_split_path_info</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token operator">?</span>\<span class="token punctuation">.</span>php<span class="token punctuation">)</span><span class="token punctuation">(</span>\<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">|</span><span class="token punctuation">)</span>$<span class="token punctuation">;</span>
        <span class="token keyword">set</span> <span class="token variable">$path_info</span> <span class="token variable">$fastcgi_path_info</span><span class="token punctuation">;</span>
        <span class="token keyword">try_files</span> <span class="token variable">$fastcgi_script_name</span> <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
        <span class="token keyword">include</span> fastcgi_params<span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_param</span> SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_param</span> PATH_INFO <span class="token variable">$path_info</span><span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_param</span> <span class="token keyword">HTTPS</span> on<span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_param</span> modHeadersAvailable <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">#宝塔默认是include调用PHP相关配置，这里稍稍修改了一下，注意php版本 #加入了front_controller_active这项参数以隐藏页面URL中的index.php</span>
        <span class="token keyword">fastcgi_param</span> front_controller_active <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>tmp<span class="token operator">/</span>php<span class="token operator">-</span>cgi<span class="token operator">-</span><span class="token number">74.</span>sock<span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_intercept_errors</span> on<span class="token punctuation">;</span>
        fastcgi_request_buffering off<span class="token punctuation">;</span>
        <span class="token keyword">include</span> fastcgi<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
        <span class="token keyword">include</span> pathinfo<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span>\<span class="token operator">/</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>updater<span class="token operator">|</span>oc<span class="token punctuation">[</span>ms<span class="token punctuation">]</span><span class="token operator">-</span>provider<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>$<span class="token operator">|</span>\<span class="token operator">/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try_files</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
        <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>css<span class="token operator">|</span>js<span class="token operator">|</span>woff2<span class="token operator">?</span><span class="token operator">|</span>svg<span class="token operator">|</span>gif<span class="token operator">|</span><span class="token keyword">map</span><span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control <span class="token string">&quot;public, max-age=15778463&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Referrer<span class="token operator">-</span>Policy <span class="token string">&quot;no-referrer&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options <span class="token string">&quot;nosniff&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Download<span class="token operator">-</span>Options <span class="token string">&quot;noopen&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Frame<span class="token operator">-</span>Options <span class="token string">&quot;SAMEORIGIN&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Permitted<span class="token operator">-</span>Cross<span class="token operator">-</span>Domain<span class="token operator">-</span>Policies <span class="token string">&quot;none&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>Robots<span class="token operator">-</span>Tag <span class="token string">&quot;none&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> X<span class="token operator">-</span>XSS<span class="token operator">-</span>Protection <span class="token string">&quot;1; mode=block&quot;</span> always<span class="token punctuation">;</span>
        <span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">:</span>png<span class="token operator">|</span>html<span class="token operator">|</span>ttf<span class="token operator">|</span>ico<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>bcmap<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
        <span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$
    <span class="token punctuation">{</span>
        <span class="token keyword">expires</span>      <span class="token number">30</span>d<span class="token punctuation">;</span>
        <span class="token keyword">error_log</span> off<span class="token punctuation">;</span>
        <span class="token keyword">access_log</span> <span class="token operator">/</span>dev<span class="token operator">/</span>null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token operator">?</span>$
    <span class="token punctuation">{</span>
        <span class="token keyword">expires</span>      <span class="token number">12</span>h<span class="token punctuation">;</span>
        <span class="token keyword">error_log</span> off<span class="token punctuation">;</span>
        <span class="token keyword">access_log</span> <span class="token operator">/</span>dev<span class="token operator">/</span>null<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-停用无用的apps-降低系统负载"><a href="#_4-停用无用的apps-降低系统负载" class="header-anchor">#</a> 4.停用无用的apps，降低系统负载</h3> <p>mysql 进去，看看变量，SHOW VARIABLES like '%flush%' 一看，</p> <p>innodb_flush_log_at_trx_commit 这个参数默认是1，就是最安全，性能最差的，改成0（找到my.cnf，docker卷下找到2个，全改了，重启mysql容器），</p> <p>我可以接受1秒宕机，数据库丢失，因为数据库全挂了，nextcloud还可以通过scan命令重新扫描。</p> <p>改成2的话，就是折中，没必要，直接改成0。</p> <p>mysql binlog关闭，没什么用，还是那句话，mysql挂了都没问题，有文件就可以，</p> <p>重新扫描，命令：docker exec nextcloud su www-data -s /bin/bash -c &quot;php /var/www/html/occ files:scan —all” 【应该有点用】</p> <h3 id="_5-上传速度优化"><a href="#_5-上传速度优化" class="header-anchor">#</a> 5.上传速度优化</h3> <div class="language- extra-class"><pre class="language-text"><code>docker exec -u 1000 容器id bash    //进入容器
find / -name  'occ'		//找到nextcloud的安装文件，我们搜occ来找
php occ config:app:set files max_chunk_size --value 0 //进入目录执行（解除块大小限制）
</code></pre></div><p>参考：https://www.jianshu.com/p/55fd5ddafb1a</p> <p>https://blog.csdn.net/qq_28718329/article/details/112687699</p> <p>https://bugxia.com/1706.html</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/5/30 下午10:59:46</span></div></footer> <!---->  <div id="gitalk-container"></div></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/syy-notes/assets/js/app.094dc226.js" defer></script><script src="/syy-notes/assets/js/2.c240e540.js" defer></script><script src="/syy-notes/assets/js/5.d4bdd74c.js" defer></script><script src="/syy-notes/assets/js/21.29e7cf26.js" defer></script><script src="/syy-notes/assets/js/6.0490b026.js" defer></script>
  </body>
</html>